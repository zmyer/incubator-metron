<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2017-02-23
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20170223" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Metron &#x2013; Indexing</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<script type="text/javascript">$( document ).ready( function() { $( '.carousel' ).carousel( { interval: 3500 } ) } );</script>
          
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://metron.incubator.apache.org/" id="bannerLeft">
                                                                                                <img src="../../images/metron-logo.png"  alt="Apache Metron - Incubating" width="148px" height="48px"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="http://incubator.apache.org/" id="bannerRight">
                                                                                                <img src="../../images/ApacheIncubating_Logo.png"  alt="Apache Incubating" width="192px" height="48px"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.apache.org" class="externalLink" title="Apache">
        Apache</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="http://metron.incubator.apache.org/" class="externalLink" title="Metron-Incubating">
        Metron-Incubating</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../../index.html" title="Documentation">
        Documentation</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Indexing</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 2017-02-23</li> <li class="divider pull-right">|</li>
              <li id="projectVersion" class="pull-right">Version: 0.3.1</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">User Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
      <li>
    
                          <a href="../../index.html" title="Metron">
          <i class="icon-chevron-down"></i>
        Metron</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../Upgrading.html" title="Upgrading">
          <i class="none"></i>
        Upgrading</a>
            </li>
                                                                                                                                                      
      <li>
    
                          <a href="../../metron-analytics/index.html" title="Analytics">
          <i class="icon-chevron-right"></i>
        Analytics</a>
                  </li>
                                                                                                                                                                                                                                                                                                                                                                  
      <li>
    
                          <a href="../../metron-deployment/index.html" title="Deployment">
          <i class="icon-chevron-right"></i>
        Deployment</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-docker/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                                                                                                                                                                                                                
      <li>
    
                          <a href="../../metron-platform/index.html" title="Platform">
          <i class="icon-chevron-down"></i>
        Platform</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../metron-platform/metron-api/index.html" title="Api">
          <i class="none"></i>
        Api</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-common/index.html" title="Common">
          <i class="none"></i>
        Common</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-data-management/index.html" title="Data-management">
          <i class="none"></i>
        Data-management</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-enrichment/index.html" title="Enrichment">
          <i class="none"></i>
        Enrichment</a>
            </li>
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>Indexing</a>
          </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-management/index.html" title="Management">
          <i class="none"></i>
        Management</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-parsers/index.html" title="Parsers">
          <i class="none"></i>
        Parsers</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-pcap-backend/index.html" title="Pcap-backend">
          <i class="none"></i>
        Pcap-backend</a>
            </li>
              </ul>
        </li>
                                                                                          
      <li>
    
                          <a href="../../metron-sensors/index.html" title="Sensors">
          <i class="icon-chevron-right"></i>
        Sensors</a>
                  </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Indexing</h1>
<p><a name="Indexing"></a></p>
<div class="section">
<h2><a name="Introduction"></a>Introduction</h2>
<p>The <tt>indexing</tt> topology is a topology dedicated to taking the data from the enrichment topology that have been enriched and storing the data in one or more supported indices</p>

<ul>
  
<li>HDFS as rolled text files, one JSON blob per line</li>
  
<li>Elasticsearch</li>
  
<li>Solr</li>
</ul>
<p>By default, this topology writes out to both HDFS and one of Elasticsearch and Solr.</p>
<p>Indices are written in batch and the batch size is specified in the <a href="#Sensor_Indexing_Configuration">Sensor Indexing Configuration</a> via the <tt>batchSize</tt> parameter. This config is variable by sensor type.</p></div>
<div class="section">
<h2><a name="Indexing_Architecture"></a>Indexing Architecture</h2>
<p><img src="../../images/indexing_arch.png" alt="Architecture" /></p>
<p>The indexing topology is extremely simple. Data is ingested into kafka and sent to </p>

<ul>
  
<li>An indexing bolt configured to write to either elasticsearch or Solr</li>
  
<li>An indexing bolt configured to write to HDFS under <tt>/apps/metron/enrichment/indexed</tt></li>
</ul>
<p>Errors during indexing are sent to a kafka queue called <tt>index_errors</tt></p></div>
<div class="section">
<h2><a name="Sensor_Indexing_Configuration"></a>Sensor Indexing Configuration</h2>
<p>The sensor specific configuration is intended to configure the indexing used for a given sensor type (e.g. <tt>snort</tt>). </p>
<p>Just like the global config, the format is a JSON stored in zookeeper and on disk at <tt>$METRON_HOME/config/zookeeper/indexing</tt>. Within the sensor-specific configuration, you can configure the individual writers. The writers currently supported are:</p>

<ul>
  
<li><tt>elasticsearch</tt></li>
  
<li><tt>hdfs</tt></li>
  
<li><tt>solr</tt></li>
</ul>
<p>Depending on how you start the indexing topology, it will have either elasticsearch or solr and hdfs writers running.</p>
<p>The configuration for an individual writer-specific configuration is a JSON map with the following fields:</p>

<ul>
  
<li><tt>index</tt> : The name of the index to write to (defaulted to the name of the sensor).</li>
  
<li><tt>batchSize</tt> : The size of the batch that is written to the indices at once (defaulted to <tt>1</tt>).</li>
  
<li><tt>enabled</tt> : Whether the writer is enabled (default <tt>true</tt>).</li>
</ul>
<div class="section">
<h3><a name="Indexing_Configuration_Examples"></a>Indexing Configuration Examples</h3>
<p>For a given sensor, the following scenarios would be indicated by the following cases:</p>
<div class="section">
<h4><a name="Base_Case"></a>Base Case</h4>

<div class="source">
<div class="source">
<pre>{
}
</pre></div></div>
<p>or no file at all.</p>

<ul>
  
<li>elasticsearch writer
  
<ul>
    
<li>enabled</li>
    
<li>batch size of 1</li>
    
<li>index name the same as the sensor</li>
  </ul></li>
  
<li>hdfs writer
  
<ul>
    
<li>enabled</li>
    
<li>batch size of 1</li>
    
<li>index name the same as the sensor</li>
  </ul></li>
</ul>
<p>If a writer config is unspecified, then a warning is indicated in the Storm console. e.g.: <tt>WARNING: Default and (likely) unoptimized writer config used for hdfs writer and sensor squid</tt></p></div>
<div class="section">
<h4><a name="Fully_specified"></a>Fully specified</h4>

<div class="source">
<div class="source">
<pre>{
   &quot;elasticsearch&quot;: {
      &quot;index&quot;: &quot;foo&quot;,
      &quot;batchSize&quot; : 100,
      &quot;enabled&quot; : true 
    },
   &quot;hdfs&quot;: {
      &quot;index&quot;: &quot;foo&quot;,
      &quot;batchSize&quot;: 1,
      &quot;enabled&quot; : true
    }
}
</pre></div></div>

<ul>
  
<li>elasticsearch writer
  
<ul>
    
<li>enabled</li>
    
<li>batch size of 100</li>
    
<li>index name of &#x201c;foo&#x201d;</li>
  </ul></li>
  
<li>hdfs writer
  
<ul>
    
<li>enabled</li>
    
<li>batch size of 1</li>
    
<li>index name of &#x201c;foo&#x201d;</li>
  </ul></li>
</ul></div>
<div class="section">
<h4><a name="HDFS_Writer_turned_off"></a>HDFS Writer turned off</h4>

<div class="source">
<div class="source">
<pre>{
   &quot;elasticsearch&quot;: {
      &quot;index&quot;: &quot;foo&quot;,
      &quot;enabled&quot; : true 
    },
   &quot;hdfs&quot;: {
      &quot;index&quot;: &quot;foo&quot;,
      &quot;batchSize&quot;: 100,
      &quot;enabled&quot; : false
    }
}
</pre></div></div>

<ul>
  
<li>elasticsearch writer
  
<ul>
    
<li>enabled</li>
    
<li>batch size of 1</li>
    
<li>index name of &#x201c;foo&#x201d;</li>
  </ul></li>
  
<li>hdfs writer
  
<ul>
    
<li>disabled</li>
  </ul></li>
</ul>
<p><a name="Notes_on_Performance_Tuning"></a></p>
<h1>Notes on Performance Tuning</h1>
<p>Default installed Metron is untuned for production deployment. By far and wide, the most likely piece to require TLC from a performance perspective is the indexing layer. An index that does not keep up will back up and you will see errors in the kafka bolt. There are a few knobs to tune to get the most out of your system.</p></div></div></div>
<div class="section">
<h2><a name="Kafka_Queue"></a>Kafka Queue</h2>
<p>The <tt>indexing</tt> kafka queue is a collection point from the enrichment topology. As such, make sure that the number of partitions in the kafka topic is sufficient to handle the throughput that you expect.</p></div>
<div class="section">
<h2><a name="Indexing_Topology"></a>Indexing Topology</h2>
<p>The enrichment topology as started by the <tt>$METRON_HOME/bin/start_elasticsearch_topology.sh</tt> or <tt>$METRON_HOME/bin/start_solr_topology.sh</tt> script uses a default of one executor per bolt. In a real production system, this should be customized by modifying the flux file in <tt>$METRON_HOME/flux/indexing/remote.yaml</tt>. </p>

<ul>
  
<li>Add a <tt>parallelism</tt> field to the bolts to give Storm a parallelism  hint for the various components. Give bolts which appear to be bottlenecks (e.g. the indexing bolt) a larger hint.</li>
  
<li>Add a <tt>parallelism</tt> field to the kafka spout which matches the number of partitions for the enrichment kafka queue.</li>
  
<li>Adjust the number of workers for the topology by adjusting the  <tt>topology.workers</tt> field for the topology.</li>
</ul>
<p>Finally, if workers and executors are new to you or you don&#x2019;t know where to modify the flux file, the following might be of use to you:</p>

<ul>
  
<li><a class="externalLink" href="http://www.michael-noll.com/blog/2012/10/16/understanding-the-parallelism-of-a-storm-topology/">Understanding the Parallelism of a Storm Topology</a></li>
  
<li><a class="externalLink" href="http://storm.apache.org/releases/current/flux.html">Flux Docs</a></li>
</ul></div>
<div class="section">
<h2><a name="Zeppelin_Notebooks"></a>Zeppelin Notebooks</h2>
<p>Zeppelin notebooks can be added to <tt>/src/main/config/zeppelin/</tt> (and subdirectories can be created for organization). The placed files must be .json files and be named appropriately. These files must be added to the metron.spec file and the RPMs rebuilt to be available to be loaded into Ambari.</p>
<p>The notebook files will be found on the server in <tt>$METRON_HOME/config/zeppelin</tt></p>
<p>The Ambari Management Pack has a custom action to load these templates, ZEPPELIN_DASHBOARD_INSTALL, that will import them into Zeppelin.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2017.
          All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
